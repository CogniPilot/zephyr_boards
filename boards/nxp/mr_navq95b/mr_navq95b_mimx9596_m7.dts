/*
 * Copyright 2025 NXP
 *
 * SPDX-License-Identifier: Apache-2.0
 */

/dts-v1/;

#include <nxp/nxp_imx95_m7.dtsi>
#include <zephyr/dt-bindings/pwm/pwm.h>
#include "mr_navq95b-pinctrl.dtsi"
#include <zephyr/dt-bindings/sensor/icm45686.h>

/ {
	model = "NXP MR-NavQ95B";
	compatible = "nxp,navq95";

	chosen {
		/* TCM */
		zephyr,flash = &itcm;
		zephyr,sram = &dtcm;

		zephyr,flash-controller = &mx25um51345g;
		zephyr,console = &lpuart2;
		zephyr,shell-uart = &lpuart2;
		zephyr,canbus = &flexcan2;
	};
};

&gpio2 {
	status = "okay";
	irq-output-select = <1>;
};

&gpio5 {
	status = "okay";
	irq-output-select = <1>;
};

&flexspi {
	status = "okay";
	ahb-prefetch;
	ahb-read-addr-opt;
	ahb-bufferable;
	ahb-cacheable;
	rx-clock-source = <1>;
	pinctrl-0 = <&flexspi_default>;
	pinctrl-names = "default";
	mx25um51345g: mx25um51345g@0 {
		compatible = "nxp,imx-flexspi-mx25um51345g";
		/* MX25UM51345G is 64MB, 512MBit flash part */
		size = <DT_SIZE_M(64*8)>;
		reg = <0>;
		spi-max-frequency = <200000000>;
		status = "okay";
		jedec-id = [c2 81 3a];
		erase-block-size = <4096>;
		write-block-size = <2>;
		cs-interval = <2>;

		partitions {
			compatible = "fixed-partitions";
			#address-cells = <1>;
			#size-cells = <1>;

			/*
			 * Partition sizes must be aligned
			 * to the flash memory sector size of 4KB.
			 * 
			 * boot_partition is left out since that will
			 * run from ITCM
			 */
			slot0_partition: partition@0 {
				label = "image-0";
				reg = <0x00000000 DT_SIZE_M(7)>;
			};
			slot1_partition: partition@700000 {
				label = "image-1";
				reg = <0x00700000 DT_SIZE_M(7)>;
			};
			storage_partition: partition@E00000 {
				label = "storage";
				reg = <0x00E00000 DT_SIZE_M(2)>;
			};
		};
	};
};

&lpspi1 {
	pinctrl-0 = <&lpspi1_default>;
	pinctrl-names = "default";
	status = "okay";
	/* cs-gpios =<&gpio1 11 GPIO_ACTIVE_LOW>; */

	icm45686: icm45686@0 {
		compatible = "invensense,icm45686";
		reg = <0>;
		int-gpios = <&gpio5 11 GPIO_ACTIVE_HIGH>;
		spi-max-frequency = <DT_FREQ_M(20)>;
		spi-cs-setup-delay-ns = <50>;
		spi-cs-hold-delay-ns = <50>;
		spi-interframe-delay-ns = <50>;
		accel-pwr-mode = <ICM45686_DT_ACCEL_LN>;
		accel-fs = <ICM45686_DT_ACCEL_FS_2>;
		accel-odr = <ICM45686_DT_ACCEL_ODR_400>;
		accel-lpf = <ICM45686_DT_ACCEL_LPF_BW_1_32>;
		gyro-pwr-mode = <ICM45686_DT_GYRO_LN>;
		gyro-fs = <ICM45686_DT_GYRO_FS_4000>;
		gyro-odr = <ICM45686_DT_GYRO_ODR_400>;
		gyro-lpf = <ICM45686_DT_GYRO_LPF_BW_1_32>;

		fifo-watermark = <1>;
	};
};

&lpspi8 {
	pinctrl-0 = <&lpspi8_default>;
	pinctrl-names = "default";
	status = "okay";

	bmi08x_accel: bmi08x@0 {
		compatible = "bosch,bmi08x-accel";
		reg = <0>;
		/* int-gpios = <&gpio3 20 GPIO_ACTIVE_HIGH>; */ // TODO
		spi-max-frequency = <DT_FREQ_M(10)>;
		spi-cs-setup-delay-ns = <50>;
		spi-cs-hold-delay-ns = <50>;
		spi-interframe-delay-ns = <50>;
		int1-map-io = <0x01>;
		int2-map-io = <0x00>;
		int1-conf-io = <0x04>;
		int2-conf-io = <0x00>;
		accel-hz = "800";
		accel-fs = <24>;
	};

	bmi08x_gyro: bmi08x@1 {
		compatible = "bosch,bmi08x-gyro";
		reg = <1>;
		/* int-gpios = <&gpio2 28 GPIO_ACTIVE_HIGH>; */ // TODO
		spi-max-frequency = <DT_FREQ_M(10)>;
		spi-cs-setup-delay-ns = <50>;
		spi-cs-hold-delay-ns = <50>;
		spi-interframe-delay-ns = <50>;
		int3-4-map-io = <0x01>;
		int3-4-conf-io = <0x02>;
		gyro-hz = "1000_116";
		gyro-fs = <1000>;
	};
};

// &lpi2c4 {
// 	status = "okay";
// 	pinctrl-0 = <&lpi2c4_default>;
// 	pinctrl-names = "default";
// };

&lpi2c6 {
	status = "okay";
	pinctrl-0 = <&lpi2c6_default>;
	pinctrl-names = "default";
};

&lpuart2 {
	status = "okay";
	current-speed = <115200>;
	pinctrl-0 = <&lpuart2_default>;
	pinctrl-names = "default";
};

&lpuart5 {
	status = "okay";
	current-speed = <115200>;
	pinctrl-0 = <&lpuart5_default>;
	pinctrl-names = "default";
};

&i3c1 {
	pinctrl-0 = <&i3c1_default>;
	pinctrl-names = "default";
	status = "okay";
	i2c-scl-hz = <400000>;

	bmp581: bmp581@460000000000000050  {
		compatible = "bosch,bmp581";
		reg = <0x46 0x0 0x50>;
	};

	bmm350: bmm350@140000000000000050  {
		compatible = "bosch,bmm350";
		reg = <0x14 0x0 0x50>;
	};
};

&flexcan2 {
	pinctrl-0 = <&flexcan2_default>;
	pinctrl-names = "default";
	status = "okay";
};

&flexcan3 {
	pinctrl-0 = <&flexcan3_default>;
	pinctrl-names = "default";
	status = "okay";
};

&tpm3 {
	status = "okay";
	pinctrl-0 = <&tpm3_pwm1_pwm2_pwm3>;
	pinctrl-names = "default";
};

&tpm4 {
	status = "okay";
	pinctrl-0 = <&tpm4_pwm4_pwm5>;
	pinctrl-names = "default";
};

&tpm5 {
	status = "okay";
	pinctrl-0 = <&tpm5_pwm6_pwm7>;
	pinctrl-names = "default";
};

//TODO TPM6 buzzer
