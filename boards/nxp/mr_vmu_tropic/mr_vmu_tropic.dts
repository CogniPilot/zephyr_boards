/*
 * Copyright 2025 NXP
 *
 * SPDX-License-Identifier: Apache-2.0
 */

/dts-v1/;

#include <nxp/nxp_rt1064.dtsi>
#include "mr_vmu_tropic-pinctrl.dtsi"
#include <zephyr/dt-bindings/input/input-event-codes.h>
#include <zephyr/dt-bindings/sensor/icm45686.h>
#include <zephyr/dt-bindings/led/led.h>

/ {
	model = "NXP MR-VMU-Tropic board";
	compatible = "nxp,mimxrt1064";

	aliases {
		sdhc0 = &usdhc1;
		rtc = &counter_rtc;
	};

	chosen {
		zephyr,flash = &w25q32jvwj0;
		zephyr,code-partition = &slot0_partition;
		zephyr,uart-mcumgr = &lpuart6;
		zephyr,sram = &ocram2;
		zephyr,itcm = &itcm;
		zephyr,dtcm = &dtcm;
		zephyr,console = &lpuart6;
		zephyr,shell-uart = &lpuart6;
		zephyr,canbus = &flexcan3;
	};

	/* This is the Arming Button on the included GPS module for 10 pin JST-GH */
	gpio_keys {
		compatible = "gpio-keys";

		arming_button: button_0 {
			label = "Arming Switch";
			gpios = <&gpio2 12 (GPIO_PULL_DOWN | GPIO_ACTIVE_HIGH)>;
			zephyr,code = <INPUT_KEY_0>;
		};
	};

	pwmleds {
		compatible = "pwm-leds";

		red_pwm_led: led_pwm_0 {
			pwms = <&flexpwm3_pwm2 0 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
			label = "Red PWM LED";
		};

		green_pwm_led: led_pwm_1 {
			pwms = <&flexpwm3_pwm2 1 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
			label = "Green PWM LED";
		};

		blue_pwm_led: led_pwm_2 {
			pwms = <&flexpwm1_pwm3 0 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
			label = "Blue PWM LED";
		};
		
		buzzer0: buzzer0 {
			pwms = <&flexpwm1_pwm0 0 PWM_HZ(50) PWM_POLARITY_NORMAL>;
		};
	};
};

/* 256KB ITCM, 256KB DTCM mapping */
&flexram {
	flexram,bank-spec = <FLEXRAM_DTCM>,
			    <FLEXRAM_DTCM>,
			    <FLEXRAM_DTCM>,
			    <FLEXRAM_DTCM>,
			    <FLEXRAM_ITCM>,
			    <FLEXRAM_ITCM>,
			    <FLEXRAM_ITCM>,
			    <FLEXRAM_ITCM>,
			    <FLEXRAM_DTCM>,
			    <FLEXRAM_DTCM>,
			    <FLEXRAM_DTCM>,
			    <FLEXRAM_DTCM>,
			    <FLEXRAM_ITCM>,
			    <FLEXRAM_ITCM>,
			    <FLEXRAM_ITCM>,
			    <FLEXRAM_ITCM>;
				
	itcm: itcm@0 {
		reg = <0x00000000 DT_SIZE_K(256)>;
	};

	dtcm: dtcm@20000000 {
		reg = <0x20000000 DT_SIZE_K(256)>;
	};

    /delete-node/ ocram@20280000;
};

&lpi2c1 {
	status = "okay";

	pinctrl-0 = <&pinmux_lpi2c1>;
	pinctrl-names = "default";

	ist8310: ist8310@e {
		compatible = "isentek,ist8310";
		reg = <0xe>;
	};

	ncp5623c: ncp5623c@39 {
		compatible = "onnn,ncp5623c";
		reg = <0x39>;

		led_0 {
			label = "GNSS LED";
			index = <0>;
			color-mapping = <LED_COLOR_ID_RED>,
					<LED_COLOR_ID_GREEN>,
					<LED_COLOR_ID_BLUE>;
		};
	};
};

&lpi2c3 {
	status = "okay";

	pinctrl-0 = <&pinmux_lpi2c3>;
	pinctrl-names = "default";
};

&lpi2c4 {
	status = "okay";

	pinctrl-0 = <&pinmux_lpi2c4>;
	pinctrl-names = "default";

	bmm350: bmm350@14 {
		compatible = "bosch,bmm350";
		reg = <0x14>;
		drdy-gpios = <&gpio4 29 GPIO_ACTIVE_HIGH>;
	};

	bmp390: bmp390@76 {
		compatible = "bosch,bmp390";
		reg = <0x76>;
		odr = "50";
		status = "okay";
	};

};

&w25q32jvwj0 {
	partitions {
		compatible = "fixed-partitions";
		#address-cells = <1>;
		#size-cells = <1>;

		/*
		 * Partition sizes must be aligned
		 * to the flash memory sector size of 4KB.
		 */
		boot_partition: partition@0 {
			label = "mcuboot";
			reg = <0x00000000 DT_SIZE_K(128)>;
		};

		slot0_partition: partition@20000 {
			label = "image-0";
			reg = <0x00020000 DT_SIZE_K(1984)>;
		};

		slot1_partition: partition@210000 {
			label = "image-1";
			reg = <0x00210000 DT_SIZE_K(1984)>;
		};
	};
};

&lpuart2 {
	status = "okay";
	pinctrl-0 = <&pinmux_lpuart2>;
	pinctrl-1 = <&pinmux_lpuart2_sleep>;
	pinctrl-names = "default", "sleep";
	current-speed = <115200>;
};

&lpuart3 {
	status = "okay";
	pinctrl-0 = <&pinmux_lpuart3>;
	pinctrl-1 = <&pinmux_lpuart3_sleep>;
	pinctrl-names = "default", "sleep";
	current-speed = <115200>;
};

&lpuart4 {
	status = "okay";
	pinctrl-0 = <&pinmux_lpuart4>;
	pinctrl-1 = <&pinmux_lpuart4_sleep>;
	pinctrl-names = "default", "sleep";
	current-speed = <115200>;
};

&lpuart5 {
	status = "okay";
	pinctrl-0 = <&pinmux_lpuart5>;
	pinctrl-1 = <&pinmux_lpuart5_sleep>;
	pinctrl-names = "default", "sleep";
	current-speed = <115200>;
};

&lpuart6 {
	status = "okay";
	pinctrl-0 = <&pinmux_lpuart6>;
	pinctrl-1 = <&pinmux_lpuart6_sleep>;
	pinctrl-names = "default", "sleep";
	current-speed = <115200>;
};

&lpuart7 {
	status = "okay";
	pinctrl-0 = <&pinmux_lpuart7>;
	pinctrl-1 = <&pinmux_lpuart7_sleep>;
	pinctrl-names = "default", "sleep";
	current-speed = <115200>;
	single-wire;
};

&lpuart8 {
	status = "okay";
	pinctrl-0 = <&pinmux_lpuart8>;
	pinctrl-1 = <&pinmux_lpuart8_sleep>;
	pinctrl-names = "default", "sleep";
	current-speed = <420000>;

	sbus0: sbus {
		compatible = "tbs,crsf";

		chan_1 {
			channel = <1>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <1>;
		};
		chan_2 {
			channel = <2>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <2>;
		};
		chan_3 {
			channel = <3>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <3>;
		};
		chan_4 {
			channel = <4>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <4>;
		};
		chan_5 {
			channel = <5>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <5>;
		};
		chan_6 {
			channel = <6>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <6>;
		};
		chan_7 {
			channel = <7>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <7>;
		};
		chan_8 {
			channel = <8>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <8>;
		};
		chan_9 {
			channel = <9>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <9>;
		};
		chan_10 {
			channel = <10>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <10>;
		};
		chan_11 {
			channel = <11>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <11>;
		};
		chan_12 {
			channel = <12>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <12>;
		};
		chan_13 {
			channel = <13>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <13>;
		};
		chan_14 {
			channel = <14>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <14>;
		};
		chan_15 {
			channel = <15>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <15>;
		};
		chan_16 {
			channel = <16>;
			type = <INPUT_EV_ABS>;
			zephyr,code = <16>;
		};
	};
};

&enet_mac {
	status = "okay";
	pinctrl-0 = <&pinmux_enet>;
	pinctrl-names = "default";
	phy-handle = <&phy>;
	zephyr,random-mac-address;
	phy-connection-type = "rmii";
};

&enet_mdio {
	status = "okay";
	pinctrl-0 = <&pinmux_enet_mdio>;
	pinctrl-names = "default";

	phy: phy@12 {
		compatible = "nxp,tja1103";
		reg = <0x12>;
		status = "okay";
		int-gpios = <&gpio2 15 GPIO_ACTIVE_HIGH>;
		master-slave = "auto";
	};
};

zephyr_udc0: &usb1 {
	status = "okay";
};

/* flexpwm output for board RGB Red/Blue LED */
&flexpwm3_pwm2 {
	status = "okay";
	pinctrl-0 = <&pinmux_flexpwm3_pwm2_rb>;
	pinctrl-names = "default";
	nxp,prescaler = <16>;
};

/* flexpwm output for board RGB Green LED */
&flexpwm1_pwm3 {
	status = "okay";
	pinctrl-0 = <&pinmux_flexpwm1_pwm3_g>;
	pinctrl-names = "default";
	nxp,prescaler = <16>;
};

/* flexpwm output for buzzer */
&flexpwm1_pwm0 {
	status = "okay";
	pinctrl-0 = <&pinmux_flexpwm1_pwm0_buzzer>;
	pinctrl-names = "default";
	nxp,prescaler = <128>;
};

&usdhc1 {
	status = "okay";
	no-1-8-v;
	cd-gpios = <&gpio3 21 GPIO_ACTIVE_LOW>;
	pinctrl-0 = <&pinmux_usdhc1>;
	pinctrl-1 = <&pinmux_usdhc1_slow>;
	pinctrl-2 = <&pinmux_usdhc1_med>;
	pinctrl-3 = <&pinmux_usdhc1_fast>;
	pinctrl-names = "default", "slow", "med", "fast";

	sdmmc {
		compatible = "zephyr,sdmmc-disk";
		disk-name = "SD";
		status = "okay";
	};
};

&edma0 {
	status = "okay";
};

&flexcan3 {
	status = "okay";
	pinctrl-0 = <&pinmux_flexcan3>;
	pinctrl-names = "default";

	can-transceiver {
		max-bitrate = <5000000>;
	};
};

&wdog0 {
	status = "okay";
};


&lpspi3 {
	status = "okay";
	/* DMA channels 2 and 3, muxed to LPSPI3 RX and TX */
	dmas = <&edma0 2 15>, <&edma0 3 16>;
	dma-names = "rx", "tx";
	pinctrl-0 = <&pinmux_lpspi3>;
	pinctrl-names = "default";

	icm45686: icm45686@0 {
		compatible = "invensense,icm45686";
		reg = <0>;
		int-gpios = <&gpio3 18 GPIO_ACTIVE_HIGH>;
		spi-max-frequency = <DT_FREQ_M(20)>;
		spi-cs-setup-delay-ns = <50>;
		spi-cs-hold-delay-ns = <50>;
		spi-interframe-delay-ns = <50>;
		accel-pwr-mode = <ICM45686_DT_ACCEL_LN>;
		accel-fs = <ICM45686_DT_ACCEL_FS_2>;
		accel-odr = <ICM45686_DT_ACCEL_ODR_400>;
		accel-lpf = <ICM45686_DT_ACCEL_LPF_BW_1_32>;
		gyro-pwr-mode = <ICM45686_DT_GYRO_LN>;
		gyro-fs = <ICM45686_DT_GYRO_FS_4000>;
		gyro-odr = <ICM45686_DT_GYRO_ODR_400>;
		gyro-lpf = <ICM45686_DT_GYRO_LPF_BW_1_32>;

		fifo-watermark = <1>;
	};
};

&lpspi4 {
	status = "okay";
	/* DMA channels 0 and 1, muxed to LPSPI4 RX and TX */
	dmas = <&edma0 0 79>, <&edma0 1 80>;
	dma-names = "rx", "tx";
	tristate-output;
	pinctrl-0 = <&pinmux_lpspi4>;
	pinctrl-names = "default";

	bmi08x_accel: bmi08x@0 {
		compatible = "bosch,bmi08x-accel";
		reg = <0>;
		int-gpios = <&gpio1 25 GPIO_ACTIVE_HIGH>;
		spi-max-frequency = <DT_FREQ_M(10)>;
		int1-map-io = <0x01>;
		int2-map-io = <0x00>;
		int1-conf-io = <0x04>;
		int2-conf-io = <0x00>;
		accel-hz = "800";
		accel-fs = <24>;
	};

	bmi08x_gyro: bmi08x@1 {
		compatible = "bosch,bmi08x-gyro";
		reg = <1>;
		spi-max-frequency = <DT_FREQ_M(10)>;
		int3-4-map-io = <0x01>;
		int3-4-conf-io = <0x02>;
		gyro-hz = "1000_116";
		gyro-fs = <1000>;
	};
};

/* GPT and Systick are enabled. If power management is enabled, the GPT
 * timer will be used instead of systick, as allows the core clock to
 * be gated.
 */
&gpt_hw_timer {
	status = "okay";
};

&systick {
	status = "okay";
};

&itm {
	pinctrl-0 = <&pinmux_swo>;
	pinctrl-names = "default";
};

&pit0 {
	status = "okay";
};

&counter_rtc {
	status = "okay";
};

&xbar1 {
	status = "okay";
};
